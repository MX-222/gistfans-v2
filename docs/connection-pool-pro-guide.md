# GistFans Pro ËøûÊé•Ê±†ÁÆ°ÁêÜÁ≥ªÁªü‰ΩøÁî®ÊåáÂçó

## üéØ Á≥ªÁªüÊ¶ÇËø∞

Âü∫‰∫é Supabase Pro ÊùÉÈôêÁöÑÂÆåÊï¥ËøûÊé•Ê±†ÁÆ°ÁêÜËß£ÂÜ≥ÊñπÊ°àÔºåÊèê‰æõÔºö

- **ÁúüÂÆûÁöÑËøûÊé•ÁªàÊ≠¢ËÉΩÂäõ**ÔºöÂà©Áî® Pro ÊùÉÈôêÊâßË°å `pg_terminate_backend`
- **Êï∞ÊçÆÂ∫ìÁ∫ßÁõëÊéß**ÔºöÁõ¥Êé•Êü•ËØ¢ `pg_stat_activity` Ëé∑ÂèñÁúüÂÆûËøûÊé•Áä∂ÊÄÅ
- **Ëá™Âä®ÂåñÁÆ°ÁêÜ**ÔºöEdge Function Êèê‰æõÂÆöÊó∂Ê∏ÖÁêÜÂíåÁ¥ßÊÄ•ÊÅ¢Â§ç
- **Êô∫ËÉΩÊü•ËØ¢Ë∑ØÁî±**ÔºöÊ†πÊçÆÊü•ËØ¢Á±ªÂûãËá™Âä®ÈÄâÊã©ÊúÄ‰Ω≥ÊâßË°åÊñπÂºè

## üöÄ Âø´ÈÄüÂºÄÂßã

### 1. ÈÉ®ÁΩ≤Á≥ªÁªü

```bash
# ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
export SUPABASE_URL="your-supabase-url"
export SUPABASE_PROJECT_REF="your-project-ref"
export SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"
export SUPABASE_ANON_KEY="your-anon-key"
export DATABASE_URL="your-database-url"

# ÊâßË°åÈÉ®ÁΩ≤ËÑöÊú¨
chmod +x scripts/deploy-connection-monitor.sh
./scripts/deploy-connection-monitor.sh
```

### 2. Âú®Â∫îÁî®‰∏≠‰ΩøÁî®

```typescript
import { 
  executeQuery, 
  executeHighPriorityQuery,
  executeTransaction,
  smartQuery,
  getConnectionHealth 
} from '@/lib/prisma-pro'

// ÊôÆÈÄöÊü•ËØ¢ÔºàËá™Âä®Ë∑ØÁî±Ôºâ
const posts = await executeQuery(
  (client) => client.post.findMany(),
  { queryName: 'get_posts', priority: 'normal' }
)

// È´ò‰ºòÂÖàÁ∫ßÊü•ËØ¢ÔºàÂº∫Âà∂‰ΩøÁî® Pro ÁÆ°ÁêÜÂô®Ôºâ
const user = await executeHighPriorityQuery(
  (client) => client.user.findUnique({ where: { id: userId } }),
  { queryName: 'get_user', timeout: 10000 }
)

// ‰∫ãÂä°Êìç‰Ωú
const result = await executeTransaction(
  async (tx) => {
    const post = await tx.post.create({ data: postData })
    await tx.user.update({ 
      where: { id: userId }, 
      data: { postCount: { increment: 1 } } 
    })
    return post
  },
  { queryName: 'create_post_transaction' }
)

// Êô∫ËÉΩÊü•ËØ¢Ë∑ØÁî±
const data = await smartQuery(
  (client) => client.post.findMany(),
  { queryType: 'read', queryName: 'list_posts' }
)
```

## üìä ÁõëÊéßÂíåÁÆ°ÁêÜ

### API Á´ØÁÇπ

#### Â∫îÁî®Â±Ç API (`/api/admin/connection-pool-pro`)

```bash
# Ëé∑ÂèñËøûÊé•ÁÆ°ÁêÜÂô®Áä∂ÊÄÅ
GET /api/admin/connection-pool-pro?action=status

# Ëé∑ÂèñËøûÊé•Ê±†ÂÅ•Â∫∑Áä∂ÊÄÅ
GET /api/admin/connection-pool-pro?action=health

# ÊâßË°åËøûÊé•Ê∏ÖÁêÜ
GET /api/admin/connection-pool-pro?action=cleanup&idle_threshold=15&max_terminations=10

# Á¥ßÊÄ•ËøûÊé•Ê±†ÈáçÁΩÆ
GET /api/admin/connection-pool-pro?action=emergency

# Ëá™Âä®ËøûÊé•Ê±†ÁÆ°ÁêÜ
GET /api/admin/connection-pool-pro?action=auto

# ÂÆåÊï¥ÁõëÊéß‰ø°ÊÅØ
GET /api/admin/connection-pool-pro?action=monitor
```

#### Edge Function API

```bash
# Âü∫Á°ÄÁõëÊéß
curl -X GET "$SUPABASE_URL/functions/v1/connection-monitor?action=monitor" \
  -H "Authorization: Bearer $SUPABASE_ANON_KEY"

# ÂÅ•Â∫∑Ê£ÄÊü•
curl -X GET "$SUPABASE_URL/functions/v1/connection-monitor?action=health" \
  -H "Authorization: Bearer $SUPABASE_ANON_KEY"

# Ëá™Âä®ÁÆ°ÁêÜ
curl -X GET "$SUPABASE_URL/functions/v1/connection-monitor?action=auto" \
  -H "Authorization: Bearer $SUPABASE_ANON_KEY"
```

### Á®ãÂ∫èÂåñÁÆ°ÁêÜ

```typescript
import { 
  getConnectionHealth,
  cleanupConnections,
  emergencyConnectionReset,
  autoManageConnections 
} from '@/lib/prisma-pro'

// Ê£ÄÊü•ËøûÊé•Ê±†ÂÅ•Â∫∑Áä∂ÊÄÅ
const health = await getConnectionHealth()
console.log('ËøûÊé•Ê±†Áä∂ÊÄÅ:', health.status)
console.log('Âà©Áî®Áéá:', health.utilizationPercentage + '%')

// ÊâßË°åÊ∏ÖÁêÜ
if (health.zombieConnections > 10) {
  const result = await cleanupConnections(15, 10)
  console.log('Ê∏ÖÁêÜ‰∫Ü', result.terminated_count, '‰∏™ÂÉµÂ∞∏ËøûÊé•')
}

// Á¥ßÊÄ•ÊÉÖÂÜµÂ§ÑÁêÜ
if (health.status === 'CRITICAL') {
  await emergencyConnectionReset()
}

// Ëá™Âä®ÁÆ°ÁêÜ
const autoResult = await autoManageConnections()
console.log('Ëá™Âä®ÁÆ°ÁêÜÁªìÊûú:', autoResult.actions_taken)
```

## üîß ÈÖçÁΩÆÈÄâÈ°π

### Pro ËøûÊé•ÁÆ°ÁêÜÂô®ÈÖçÁΩÆ

```typescript
const proManager = getProConnectionManager({
  maxConnections: 100,           // Pro ËÆ°ÂàíËøûÊé•ÈôêÂà∂
  zombieThresholdMinutes: 15,    // ÂÉµÂ∞∏ËøûÊé•ÈòàÂÄº
  healthCheckInterval: 30000,    // ÂÅ•Â∫∑Ê£ÄÊü•Èó¥Èöî
  autoCleanupEnabled: true,      // ÂêØÁî®Ëá™Âä®Ê∏ÖÁêÜ
  connectionTimeout: 10000,      // ËøûÊé•Ë∂ÖÊó∂
  queryTimeout: 30000,           // Êü•ËØ¢Ë∂ÖÊó∂
  retryAttempts: 3,              // ÈáçËØïÊ¨°Êï∞
  edgeFunctionUrl: 'your-edge-function-url'
})
```

### Êü•ËØ¢‰ºòÂÖàÁ∫ß

- **high**: ÂÖ≥ÈîÆ‰∏öÂä°Êü•ËØ¢ÔºåÂº∫Âà∂‰ΩøÁî® Pro ÁÆ°ÁêÜÂô®
- **normal**: ÊôÆÈÄöÊü•ËØ¢Ôºå‰ºòÂÖà‰ΩøÁî®Ê†áÂáÜÂÆ¢Êà∑Á´ØÔºåÂ§±Ë¥•Êó∂ÈôçÁ∫ß
- **low**: ÊâπÈáèÊü•ËØ¢Ôºå‰ΩøÁî®ÈòüÂàóÁÆ°ÁêÜ

### Êü•ËØ¢Á±ªÂûãË∑ØÁî±

- **read**: ËØªÂèñÊü•ËØ¢ÔºåÊôÆÈÄö‰ºòÂÖàÁ∫ß
- **write**: ÂÜôÂÖ•Êü•ËØ¢ÔºåÈ´ò‰ºòÂÖàÁ∫ßÔºåÊõ¥Â§öÈáçËØï
- **transaction**: ‰∫ãÂä°Êü•ËØ¢ÔºåÈ´ò‰ºòÂÖàÁ∫ßÔºåÊõ¥ÈïøË∂ÖÊó∂
- **batch**: ÊâπÈáèÊü•ËØ¢Ôºå‰Ωé‰ºòÂÖàÁ∫ßÔºåÈòüÂàóÂ§ÑÁêÜ

## üìà ÁõëÊéßÊåáÊ†á

### ËøûÊé•Ê±†ÂÅ•Â∫∑Áä∂ÊÄÅ

```json
{
  "status": "HEALTHY|WARNING|CRITICAL|CLEANUP_NEEDED",
  "totalConnections": 45,
  "activeConnections": 12,
  "idleConnections": 33,
  "zombieConnections": 2,
  "utilizationPercentage": 45.0,
  "maxConnections": 100,
  "lastCheck": "2025-07-30T10:00:00Z"
}
```

### ÂëäË≠¶ÈòàÂÄº

- **CRITICAL**: Âà©Áî®Áéá > 90% ÊàñÁä∂ÊÄÅ‰∏∫ CRITICAL
- **WARNING**: Âà©Áî®Áéá > 80% ÊàñÂÉµÂ∞∏ËøûÊé• > 20
- **CLEANUP_NEEDED**: ÂÉµÂ∞∏ËøûÊé• > 10
- **HEALTHY**: Ê≠£Â∏∏Áä∂ÊÄÅ

## üö® ÊïÖÈöúÂ§ÑÁêÜ

### ËøûÊé•Ê±†ËÄóÂ∞Ω

```typescript
// Ëá™Âä®Â§ÑÁêÜ
await autoManageConnections()

// ÊâãÂä®Â§ÑÁêÜ
if (health.utilizationPercentage > 90) {
  await emergencyConnectionReset()
} else if (health.zombieConnections > 10) {
  await cleanupConnections(10, 15)
}
```

### Êü•ËØ¢Ë∂ÖÊó∂

```typescript
// Â¢ûÂä†Ë∂ÖÊó∂Êó∂Èó¥
await executeQuery(queryFn, { 
  timeout: 60000,  // 60Áßí
  retries: 5       // 5Ê¨°ÈáçËØï
})

// ‰ΩøÁî®‰∫ãÂä°Êü•ËØ¢ÔºàÊõ¥ÈïøË∂ÖÊó∂Ôºâ
await executeTransaction(transactionFn, { 
  timeout: 120000  // 2ÂàÜÈíü
})
```

### ËøûÊé•Ê≥ÑÊºèÊ£ÄÊµã

```typescript
// ÁõëÊéßËøûÊé•‰ΩøÁî®ÊÉÖÂÜµ
const status = getConnectionManagerStatus()
console.log('ÈòüÂàóÈïøÂ∫¶:', status.queueLength)
console.log('Â§ÑÁêÜÁä∂ÊÄÅ:', status.isProcessingQueue)

// ÂÆöÊúüÂÅ•Â∫∑Ê£ÄÊü•
setInterval(async () => {
  const health = await getConnectionHealth()
  if (health.utilizationPercentage > 80) {
    console.warn('ËøûÊé•Ê±†Âà©Áî®ÁéáËøáÈ´ò:', health.utilizationPercentage)
  }
}, 60000)
```

## üîÑ ÂÆöÊó∂‰ªªÂä°ÔºàÂèØÈÄâÔºâ

Âú® Supabase ÊéßÂà∂Âè∞ÂêØÁî® `pg_cron` Êâ©Â±ïÂêéÔºö

```sql
-- ÊØè5ÂàÜÈíüÊ£ÄÊü•ËøûÊé•Ê±†ÂÅ•Â∫∑Áä∂ÊÄÅ
SELECT cron.schedule(
  'connection-health-check', 
  '*/5 * * * *', 
  'SELECT monitor_connections();'
);

-- ÊØè15ÂàÜÈíüÊ∏ÖÁêÜÂÉµÂ∞∏ËøûÊé•
SELECT cron.schedule(
  'zombie-cleanup', 
  '*/15 * * * *', 
  'SELECT terminate_idle_connections(15, 10);'
);

-- ÊØèÂ∞èÊó∂ËÆ∞ÂΩïËøûÊé•Ê±†Áä∂ÊÄÅ
SELECT cron.schedule(
  'connection-logging', 
  '0 * * * *', 
  'INSERT INTO connection_logs (event_type, details) 
   SELECT ''HOURLY_REPORT'', connection_pool_health_check();'
);
```

## üìä ÊÄßËÉΩ‰ºòÂåñÂª∫ËÆÆ

1. **Êü•ËØ¢‰ºòÂåñ**Ôºö‰ΩøÁî®ÈÄÇÂΩìÁöÑÊü•ËØ¢Á±ªÂûãÂíå‰ºòÂÖàÁ∫ß
2. **ËøûÊé•Â§çÁî®**ÔºöÈÅøÂÖçÂàõÂª∫ËøáÂ§öÁöÑ PrismaClient ÂÆû‰æã
3. **ÊâπÈáèÂ§ÑÁêÜ**Ôºö‰ΩøÁî® `executeBatchQueries` Â§ÑÁêÜÂ§ßÈáèÊü•ËØ¢
4. **ÁºìÂ≠òÁ≠ñÁï•**ÔºöÂØπÈ¢ëÁπÅÊü•ËØ¢ÂÆûÊñΩÁºìÂ≠ò
5. **ÁõëÊéßÂëäË≠¶**ÔºöËÆæÁΩÆËøûÊé•Ê±†Âà©Áî®ÁéáÂëäË≠¶

## üîç ÊïÖÈöúÊéíÊü•

### Â∏∏ËßÅÈóÆÈ¢ò

1. **Edge Function ÈÉ®ÁΩ≤Â§±Ë¥•**
   - Ê£ÄÊü• Supabase CLI ÁâàÊú¨
   - Á°ÆËÆ§È°πÁõÆÊùÉÈôê
   - È™åËØÅÁéØÂ¢ÉÂèòÈáè

2. **ËøûÊé•Ê∏ÖÁêÜÊó†Êïà**
   - Á°ÆËÆ§ Pro ËÆ°ÂàíÊùÉÈôê
   - Ê£ÄÊü•Êï∞ÊçÆÂ∫ìÂáΩÊï∞ÊùÉÈôê
   - È™åËØÅ `pg_terminate_backend` ÊùÉÈôê

3. **Êü•ËØ¢Ë∂ÖÊó∂**
   - Â¢ûÂä†Ë∂ÖÊó∂Êó∂Èó¥
   - Ê£ÄÊü•Êü•ËØ¢Â§çÊùÇÂ∫¶
   - ‰ºòÂåñÊï∞ÊçÆÂ∫ìÁ¥¢Âºï

4. **ËøûÊé•Ê≥ÑÊºè**
   - Ê£ÄÊü•Â∫îÁî®‰ª£Á†Å‰∏≠ÁöÑËøûÊé•‰ΩøÁî®
   - Á°ÆËÆ§‰∫ãÂä°Ê≠£Á°ÆÊèê‰∫§/ÂõûÊªö
   - ÁõëÊéßÈïøÊó∂Èó¥ËøêË°åÁöÑÊü•ËØ¢

### Ë∞ÉËØïÊ®°Âºè

```typescript
// ÂêØÁî®ËØ¶ÁªÜÊó•Âøó
process.env.NODE_ENV = 'development'

// ÁõëÊéßÊâÄÊúâÊü•ËØ¢
const result = await withConnectionMonitoring(
  () => executeQuery(queryFn),
  'debug_query'
)
```

## üöÄ Edge Function ÈÉ®ÁΩ≤‰ª£Á†Å

ÂàõÂª∫ `supabase/functions/connection-monitor/index.ts` Êñá‰ª∂ÔºåÂÜÖÂÆπÂ¶Ç‰∏ãÔºö

```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

interface ConnectionMetrics {
  total_conn: number
  active_conn: number
  idle_conn: number
  zombie_conn: number
  long_idle_conn: number
  utilization_pct: number
  max_conn: number
  status: string
}

interface CleanupResult {
  terminated_count: number
  remaining_zombies: number
  details: any
}

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!

    const supabase = createClient(supabaseUrl, supabaseServiceKey)

    const url = new URL(req.url)
    const action = url.searchParams.get('action') || 'monitor'

    console.log(`üîç Connection Monitor Action: ${action}`)

    switch (action) {
      case 'monitor':
        return await handleMonitor(supabase)
      case 'cleanup':
        return await handleCleanup(supabase, url.searchParams)
      case 'emergency':
        return await handleEmergency(supabase)
      case 'health':
        return await handleHealthCheck(supabase)
      case 'auto':
        return await handleAutoManagement(supabase)
      default:
        return new Response(
          JSON.stringify({ error: 'Invalid action. Use: monitor, cleanup, emergency, health, auto' }),
          { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
        )
    }
  } catch (error) {
    console.error('‚ùå Connection Monitor Error:', error)
    return new Response(
      JSON.stringify({ error: 'Internal server error', details: error.message }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  }
})

async function handleMonitor(supabase: any) {
  const { data, error } = await supabase.rpc('monitor_connections')
  if (error) throw error

  const metrics = data[0] as ConnectionMetrics
  return new Response(
    JSON.stringify({
      success: true,
      action: 'monitor',
      metrics,
      timestamp: new Date().toISOString(),
      recommendations: getRecommendations(metrics)
    }),
    { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
  )
}

async function handleCleanup(supabase: any, params: URLSearchParams) {
  const idleThreshold = parseInt(params.get('idle_threshold') || '15')
  const maxTerminations = parseInt(params.get('max_terminations') || '10')

  const { data, error } = await supabase.rpc('terminate_idle_connections', {
    idle_threshold_minutes: idleThreshold,
    max_terminations: maxTerminations
  })

  if (error) throw error

  return new Response(
    JSON.stringify({
      success: true,
      action: 'cleanup',
      result: data[0],
      timestamp: new Date().toISOString()
    }),
    { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
  )
}

async function handleEmergency(supabase: any) {
  const { data, error } = await supabase.rpc('emergency_connection_reset')
  if (error) throw error

  return new Response(
    JSON.stringify({
      success: true,
      action: 'emergency',
      results: data,
      timestamp: new Date().toISOString()
    }),
    { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
  )
}

async function handleHealthCheck(supabase: any) {
  const { data, error } = await supabase.rpc('connection_pool_health_check')
  if (error) throw error

  return new Response(
    JSON.stringify({
      success: true,
      action: 'health',
      health: data,
      timestamp: new Date().toISOString()
    }),
    { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
  )
}

async function handleAutoManagement(supabase: any) {
  const { data: healthData, error: healthError } = await supabase.rpc('connection_pool_health_check')
  if (healthError) throw healthError

  const health = healthData as any
  const status = health.status
  const utilization = health.metrics?.utilization_percentage || 0
  const zombies = health.metrics?.zombie_connections || 0

  const actions = []

  if (status === 'CRITICAL' || utilization > 90) {
    const { data: emergencyData, error: emergencyError } = await supabase.rpc('emergency_connection_reset')
    if (!emergencyError) {
      actions.push({
        action: 'emergency_reset',
        reason: 'Critical utilization > 90%',
        results: emergencyData
      })
    }
  } else if (status === 'CLEANUP_NEEDED' || zombies > 10) {
    const { data: cleanupData, error: cleanupError } = await supabase.rpc('terminate_idle_connections', {
      idle_threshold_minutes: 10,
      max_terminations: 15
    })
    if (!cleanupError) {
      actions.push({
        action: 'zombie_cleanup',
        reason: `${zombies} zombie connections detected`,
        results: cleanupData[0]
      })
    }
  } else if (status === 'WARNING' || utilization > 80) {
    const { data: cleanupData, error: cleanupError } = await supabase.rpc('terminate_idle_connections', {
      idle_threshold_minutes: 15,
      max_terminations: 5
    })
    if (!cleanupError) {
      actions.push({
        action: 'gentle_cleanup',
        reason: `Warning utilization ${utilization}%`,
        results: cleanupData[0]
      })
    }
  } else {
    actions.push({
      action: 'no_action',
      reason: 'System healthy',
      results: null
    })
  }

  const { data: finalHealthData } = await supabase.rpc('connection_pool_health_check')

  return new Response(
    JSON.stringify({
      success: true,
      action: 'auto_management',
      initial_status: status,
      initial_utilization: utilization,
      actions_taken: actions,
      final_health: finalHealthData,
      timestamp: new Date().toISOString()
    }),
    { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
  )
}

function getRecommendations(metrics: ConnectionMetrics): string[] {
  const recommendations = []

  if (metrics.utilization_pct > 90) {
    recommendations.push('CRITICAL: Execute emergency cleanup immediately')
    recommendations.push('Check for connection leaks in application code')
    recommendations.push('Consider scaling database resources')
  } else if (metrics.utilization_pct > 80) {
    recommendations.push('WARNING: High connection utilization detected')
    recommendations.push('Monitor closely and prepare for cleanup')
  }

  if (metrics.zombie_conn > 10) {
    recommendations.push(`${metrics.zombie_conn} zombie connections detected - cleanup recommended`)
  }

  if (metrics.long_idle_conn > 5) {
    recommendations.push(`${metrics.long_idle_conn} long-idle connections - consider timeout adjustment`)
  }

  if (recommendations.length === 0) {
    recommendations.push('Connection pool is healthy')
  }

  return recommendations
}

console.log('üöÄ GistFans Connection Monitor Edge Function started')
```

## üìû ÊîØÊåÅ

Â¶ÇÊúâÈóÆÈ¢òÔºåËØ∑Ê£ÄÊü•Ôºö
1. Supabase Pro ËÆ°ÂàíÊòØÂê¶ÊøÄÊ¥ª
2. Êï∞ÊçÆÂ∫ìÂáΩÊï∞ÊòØÂê¶Ê≠£Á°ÆÈÉ®ÁΩ≤
3. Edge Function ÊòØÂê¶Ê≠£Â∏∏ËøêË°å
4. ÁéØÂ¢ÉÂèòÈáèÊòØÂê¶Ê≠£Á°ÆÈÖçÁΩÆ
