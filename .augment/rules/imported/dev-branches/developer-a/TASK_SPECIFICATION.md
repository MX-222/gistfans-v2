---
type: "manual"
---

# Developer A - å‘å¸–ç³»ç»Ÿä¿®å¤ä»»åŠ¡è§„æ ¼

## ğŸ¯ ä»»åŠ¡æ¦‚è§ˆ

**è´Ÿè´£äºº**: Developer A  
**æ¨¡å—**: å‘å¸–ç³»ç»Ÿä¿®å¤ (Post System Fix)  
**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜ä¼˜å…ˆçº§ (å…¶ä»–æ¨¡å—ä¾èµ–)  
**é¢„ä¼°å·¥æœŸ**: 3-4å¤©  
**Gitåˆ†æ”¯**: `feature/post-fix`  

## ğŸ“‹ æ ¸å¿ƒé—®é¢˜è¯Šæ–­

### ğŸ”´ å½“å‰å·²çŸ¥é—®é¢˜
1. **æ•°æ®æŒä¹…åŒ–å¤±è´¥**
   - ç—‡çŠ¶: å¸–å­å‘å¸ƒåé¡µé¢åˆ·æ–°æ—¶æ¶ˆå¤±
   - å½±å“: ç”¨æˆ·Aå‘å¸ƒçš„å¸–å­ï¼Œç”¨æˆ·Bæ— æ³•çœ‹åˆ°
   - ç–‘ä¼¼åŸå› : æ•°æ®åº“è¿æ¥é—®é¢˜æˆ–äº‹åŠ¡å¤„ç†å¼‚å¸¸

2. **æ•°æ®åº“è¿æ¥ä¸ç¨³å®š**
   - ç—‡çŠ¶: é—´æ­‡æ€§çš„æ•°æ®åº“æ“ä½œå¤±è´¥
   - å½±å“: å½±å“æ‰€æœ‰æ•°æ®ç›¸å…³åŠŸèƒ½
   - ç–‘ä¼¼åŸå› : è¿æ¥æ± é…ç½®æˆ–Prismaé…ç½®é—®é¢˜

3. **æ¨¡æ‹Ÿæ•°æ®å¹²æ‰°**
   - ç—‡çŠ¶: çœŸå®æ•°æ®ä¸æ¨¡æ‹Ÿæ•°æ®æ··åˆæ˜¾ç¤º
   - å½±å“: æ•°æ®ä¸€è‡´æ€§é—®é¢˜
   - ç–‘ä¼¼åŸå› : Contextæ•°æ®ä¸æ•°æ®åº“æ•°æ®å†²çª

## ğŸ”§ æŠ€æœ¯ä¿®å¤ç›®æ ‡

### é˜¶æ®µä¸€ï¼šé—®é¢˜è¯Šæ–­ (Day 1)
- [ ] **æ•°æ®åº“è¿æ¥è¯Šæ–­**
  - æ£€æŸ¥Prismaå®¢æˆ·ç«¯é…ç½®
  - éªŒè¯æ•°æ®åº“è¿æ¥æ± è®¾ç½®
  - æµ‹è¯•æ•°æ®åº“è¿æ¥ç¨³å®šæ€§
  - åˆ†æè¿æ¥è¶…æ—¶å’Œé‡è¯•æœºåˆ¶

- [ ] **æ•°æ®æŒä¹…åŒ–åˆ†æ**
  - è¿½è¸ªå¸–å­åˆ›å»ºAPIè°ƒç”¨æµç¨‹
  - æ£€æŸ¥äº‹åŠ¡å¤„ç†é€»è¾‘
  - éªŒè¯æ•°æ®å†™å…¥å’Œè¯»å–ä¸€è‡´æ€§
  - åˆ†æç¼“å­˜æœºåˆ¶å½±å“

- [ ] **æ¨¡æ‹Ÿæ•°æ®æ¸…ç†**
  - è¯†åˆ«Contextä¸­çš„æ¨¡æ‹Ÿæ•°æ®
  - åˆ†ç¦»çœŸå®æ•°æ®å’Œæµ‹è¯•æ•°æ®
  - å»ºç«‹æ•°æ®æºä¼˜å…ˆçº§æœºåˆ¶

### é˜¶æ®µäºŒï¼šæ ¸å¿ƒä¿®å¤ (Day 2-3)
- [ ] **æ•°æ®åº“å±‚ä¼˜åŒ–**
  - ä¼˜åŒ–Prismaè¿æ¥é…ç½®
  - å®ç°è¿æ¥æ± ç®¡ç†
  - æ·»åŠ æ•°æ®åº“å¥åº·æ£€æŸ¥
  - å®ç°è‡ªåŠ¨é‡è¿æœºåˆ¶

- [ ] **APIå±‚é‡æ„**
  - é‡å†™å¸–å­åˆ›å»ºAPI
  - å®ç°äº‹åŠ¡å¤„ç†ä¼˜åŒ–
  - æ·»åŠ æ•°æ®éªŒè¯å±‚
  - å®ç°é”™è¯¯å¤„ç†æœºåˆ¶

- [ ] **æ•°æ®ä¸€è‡´æ€§ä¿è¯**
  - å®ç°æ•°æ®åŒæ­¥æœºåˆ¶
  - æ·»åŠ æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
  - å»ºç«‹æ•°æ®æ¢å¤ç­–ç•¥
  - å®ç°ç¼“å­˜å¤±æ•ˆæœºåˆ¶

### é˜¶æ®µä¸‰ï¼šåŠŸèƒ½å¢å¼º (Day 4)
- [ ] **æ€§èƒ½ä¼˜åŒ–**
  - å®ç°æŸ¥è¯¢ä¼˜åŒ–
  - æ·»åŠ æ•°æ®åº“ç´¢å¼•
  - å®ç°åˆ†é¡µåŠ è½½
  - ä¼˜åŒ–æ•°æ®ä¼ è¾“

- [ ] **ç›‘æ§å’Œæ—¥å¿—**
  - æ·»åŠ è¯¦ç»†æ—¥å¿—è®°å½•
  - å®ç°æ€§èƒ½ç›‘æ§
  - å»ºç«‹é”™è¯¯è¿½è¸ª
  - å®ç°æ•°æ®ç»Ÿè®¡

## ğŸ—„ï¸ æ•°æ®åº“ä¿®å¤è®¡åˆ’

### Prismaé…ç½®ä¼˜åŒ–
```typescript
// prisma/schema.prisma ä¼˜åŒ–
generator client {
  provider = "prisma-client-js"
  previewFeatures = ["jsonProtocol"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
```

### è¿æ¥æ± é…ç½®
```typescript
// src/lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined
}

export const prisma = globalForPrisma.prisma ?? new PrismaClient({
  log: ['query', 'error', 'warn'],
  datasources: {
    db: {
      url: process.env.DATABASE_URL,
    },
  },
})

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```

### æ•°æ®æ¨¡å‹ä¼˜åŒ–
```sql
-- æ·»åŠ å¿…è¦çš„ç´¢å¼•
CREATE INDEX idx_post_user_created ON Post(userId, createdAt DESC);
CREATE INDEX idx_post_status_created ON Post(status, createdAt DESC);
CREATE INDEX idx_post_tags ON Post USING GIN(tags);

-- æ·»åŠ æ•°æ®å®Œæ•´æ€§çº¦æŸ
ALTER TABLE Post ADD CONSTRAINT check_content_length 
  CHECK (char_length(content) >= 1 AND char_length(content) <= 10000);

-- æ·»åŠ çŠ¶æ€å­—æ®µ
ALTER TABLE Post ADD COLUMN status PostStatus DEFAULT 'PUBLISHED';
ALTER TABLE Post ADD COLUMN version INTEGER DEFAULT 1;
```

## ğŸ”Œ APIé‡æ„è§„æ ¼

### å¸–å­åˆ›å»ºAPIé‡å†™
```typescript
// src/app/api/posts/route.ts
export async function POST(request: NextRequest) {
  try {
    // 1. èº«ä»½éªŒè¯
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return NextResponse.json({
        success: false,
        error: { code: 'UNAUTHORIZED', message: 'ç”¨æˆ·æœªç™»å½•' }
      }, { status: 401 })
    }

    // 2. æ•°æ®éªŒè¯
    const body = await request.json()
    const validatedData = postCreateSchema.parse(body)

    // 3. æ•°æ®åº“äº‹åŠ¡
    const post = await prisma.$transaction(async (tx) => {
      // åˆ›å»ºå¸–å­
      const newPost = await tx.post.create({
        data: {
          ...validatedData,
          userId: session.user.id,
          status: 'PUBLISHED',
          version: 1
        },
        include: {
          user: {
            select: { id: true, name: true, image: true }
          },
          _count: {
            select: { comments: true, starVotes: true }
          }
        }
      })

      // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
      await tx.user.update({
        where: { id: session.user.id },
        data: { postCount: { increment: 1 } }
      })

      return newPost
    })

    // 4. ç¼“å­˜æ›´æ–°
    await invalidatePostCache()

    // 5. è¿”å›ç»“æœ
    return NextResponse.json({
      success: true,
      data: { post },
      meta: { timestamp: new Date().toISOString() }
    })

  } catch (error) {
    console.error('å¸–å­åˆ›å»ºå¤±è´¥:', error)
    return NextResponse.json({
      success: false,
      error: { 
        code: 'INTERNAL_ERROR', 
        message: 'å¸–å­åˆ›å»ºå¤±è´¥',
        details: process.env.NODE_ENV === 'development' ? error.message : undefined
      }
    }, { status: 500 })
  }
}
```

### å¸–å­æŸ¥è¯¢APIä¼˜åŒ–
```typescript
// src/app/api/posts/route.ts
export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)
    const page = parseInt(searchParams.get('page') || '1')
    const limit = parseInt(searchParams.get('limit') || '20')
    const userId = searchParams.get('userId')
    const tag = searchParams.get('tag')

    const where: Prisma.PostWhereInput = {
      status: 'PUBLISHED',
      ...(userId && { userId }),
      ...(tag && { tags: { has: tag } })
    }

    const [posts, total] = await Promise.all([
      prisma.post.findMany({
        where,
        include: {
          user: {
            select: { id: true, name: true, image: true, isVerified: true }
          },
          _count: {
            select: { comments: true, starVotes: true }
          }
        },
        orderBy: { createdAt: 'desc' },
        skip: (page - 1) * limit,
        take: limit
      }),
      prisma.post.count({ where })
    ])

    return NextResponse.json({
      success: true,
      data: { posts },
      meta: {
        pagination: {
          page,
          limit,
          total,
          totalPages: Math.ceil(total / limit)
        },
        timestamp: new Date().toISOString()
      }
    })

  } catch (error) {
    console.error('å¸–å­æŸ¥è¯¢å¤±è´¥:', error)
    return NextResponse.json({
      success: false,
      error: { code: 'INTERNAL_ERROR', message: 'å¸–å­æŸ¥è¯¢å¤±è´¥' }
    }, { status: 500 })
  }
}
```

## ğŸ§© å‰ç«¯ç»„ä»¶é‡æ„

### PostFormç»„ä»¶ä¼˜åŒ–
```typescript
// src/components/PostForm.tsx
export default function PostForm({ onSuccess }: { onSuccess?: () => void }) {
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)
  
  const handleSubmit = async (data: PostFormData) => {
    setIsSubmitting(true)
    setError(null)
    
    try {
      const response = await fetch('/api/posts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      
      const result = await response.json()
      
      if (!result.success) {
        throw new Error(result.error?.message || 'å‘å¸ƒå¤±è´¥')
      }
      
      // æˆåŠŸå¤„ç†
      toast.success('å¸–å­å‘å¸ƒæˆåŠŸï¼')
      onSuccess?.()
      
    } catch (error) {
      setError(error.message)
      toast.error(error.message)
    } finally {
      setIsSubmitting(false)
    }
  }
  
  // ... ç»„ä»¶æ¸²æŸ“é€»è¾‘
}
```

## ğŸ“Š æµ‹è¯•éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½æµ‹è¯•
- [ ] å¸–å­åˆ›å»ºæˆåŠŸç‡ > 99%
- [ ] å¸–å­æ•°æ®æŒä¹…åŒ–éªŒè¯
- [ ] å¤šç”¨æˆ·å¹¶å‘å‘å¸–æµ‹è¯•
- [ ] å¸–å­ç¼–è¾‘å’Œåˆ é™¤åŠŸèƒ½
- [ ] å¸–å­æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½

### æ€§èƒ½æµ‹è¯•
- [ ] å¸–å­åˆ›å»ºå“åº”æ—¶é—´ < 500ms
- [ ] å¸–å­åˆ—è¡¨åŠ è½½æ—¶é—´ < 1s
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–éªŒè¯
- [ ] å¹¶å‘å¤„ç†èƒ½åŠ›æµ‹è¯•

### æ•°æ®ä¸€è‡´æ€§æµ‹è¯•
- [ ] æ•°æ®åº“äº‹åŠ¡å®Œæ•´æ€§
- [ ] ç¼“å­˜ä¸æ•°æ®åº“åŒæ­¥
- [ ] é”™è¯¯æ¢å¤æœºåˆ¶éªŒè¯
- [ ] æ•°æ®å¤‡ä»½å’Œæ¢å¤æµ‹è¯•

---

**ä»»åŠ¡åˆ›å»ºæ—¶é—´**: 2025-07-19  
**è´Ÿè´£å¼€å‘è€…**: Developer A  
**ä¾èµ–å…³ç³»**: æ—  (åŸºç¡€æ¨¡å—)  
**è¢«ä¾èµ–**: Developer B, C, Dçš„æ‰€æœ‰åŠŸèƒ½
