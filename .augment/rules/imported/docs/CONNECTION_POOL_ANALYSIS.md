---
type: "manual"
---

# æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨åœºæ™¯è¯¦ç»†åˆ†æ

## ğŸ“Š **åœºæ™¯è®¾ç½®**
- **ç”¨æˆ·A**: åˆå§‹è®¿é—®feedé¡µé¢
- **ç”¨æˆ·B**: 1åˆ†é’Ÿåè®¿é—®feedé¡µé¢  
- **ä¼˜åŒ–ç›®æ ‡**: å®ç°è¯„è®ºæ‡’åŠ è½½ï¼Œå‡å°‘åˆå§‹è¿æ¥æ± å ç”¨

## ğŸ” **å½“å‰æŸ¥è¯¢æ¨¡å¼åˆ†æ**

### **ç”¨æˆ·Aè®¿é—®æ—¶çš„æŸ¥è¯¢æ¬¡æ•°ï¼ˆä¼˜åŒ–å‰ï¼‰**

#### 1. **å¸–å­åˆ—è¡¨æŸ¥è¯¢**
```sql
-- æŸ¥è¯¢1: è·å–å¸–å­æ€»æ•°
SELECT COUNT(*) FROM Post WHERE status = 'PUBLISHED' AND isPublic = true

-- æŸ¥è¯¢2: è·å–å¸–å­åˆ—è¡¨ï¼ˆå¤æ‚JOINæŸ¥è¯¢ï¼‰
SELECT posts.*, 
       COUNT(comments) as comment_count,
       COUNT(likes) as like_count,
       COUNT(star_votes) as star_count,
       users.name, users.image, users.githubLogin
FROM posts 
LEFT JOIN comments ON posts.id = comments.post_id
LEFT JOIN likes ON posts.id = likes.post_id  
LEFT JOIN star_votes ON posts.id = star_votes.post_id
LEFT JOIN users ON posts.author_id = users.id
WHERE posts.status = 'PUBLISHED' AND posts.isPublic = true
GROUP BY posts.id
ORDER BY posts.created_at DESC
LIMIT 20 OFFSET 0
```
**è¿æ¥å ç”¨**: 2ä¸ªè¿æ¥ï¼ŒæŒç»­æ—¶é—´: 6ç§’

#### 2. **è¯„è®ºæ•°é‡æŸ¥è¯¢ï¼ˆå½“å‰é—®é¢˜æ‰€åœ¨ï¼‰**
```typescript
// ä¸ºæ¯ä¸ªå¸–å­å•ç‹¬æŸ¥è¯¢è¯„è®ºæ•°é‡
postIds.map(async (postId) => {
  // æ¯ä¸ªæŸ¥è¯¢å ç”¨1ä¸ªè¿æ¥
  await getCommentCount(postId) // è°ƒç”¨ /api/comments?postId=xxx
})
```

**è¯¦ç»†æŸ¥è¯¢åˆ†è§£**:
```sql
-- 20ä¸ªå¸–å­ = 20ä¸ªå¹¶å‘æŸ¥è¯¢
SELECT COUNT(*) FROM Comment WHERE postId = 'post1'  -- è¿æ¥1
SELECT COUNT(*) FROM Comment WHERE postId = 'post2'  -- è¿æ¥2
SELECT COUNT(*) FROM Comment WHERE postId = 'post3'  -- è¿æ¥3
...
SELECT COUNT(*) FROM Comment WHERE postId = 'post20' -- è¿æ¥20
```
**è¿æ¥å ç”¨**: 20ä¸ªå¹¶å‘è¿æ¥ï¼ŒæŒç»­æ—¶é—´: 1-2ç§’

#### 3. **ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢**
```sql
-- æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆå·²ä¼˜åŒ–ï¼‰
SELECT id, name, image, githubLogin, isVerified 
FROM User 
WHERE id IN ('user1', 'user2', ...)
```
**è¿æ¥å ç”¨**: 1ä¸ªè¿æ¥ï¼ŒæŒç»­æ—¶é—´: 0.5ç§’

### **ç”¨æˆ·Aæ€»è¿æ¥ä½¿ç”¨ç»Ÿè®¡**
| æŸ¥è¯¢ç±»å‹ | è¿æ¥æ•° | æŒç»­æ—¶é—´ | å¹¶å‘å³°å€¼ |
|----------|--------|----------|----------|
| å¸–å­åˆ—è¡¨ | 2 | 6ç§’ | 2 |
| è¯„è®ºæ•°é‡ | 20 | 1-2ç§’ | 20 |
| ç”¨æˆ·ä¿¡æ¯ | 1 | 0.5ç§’ | 1 |
| **æ€»è®¡** | **23** | **6ç§’** | **23** |

---

### **ç”¨æˆ·Bè®¿é—®æ—¶çš„æŸ¥è¯¢æ¬¡æ•°ï¼ˆ1åˆ†é’Ÿåï¼‰**

#### ç¼“å­˜å‘½ä¸­æƒ…å†µåˆ†æ
```typescript
// å¸–å­åˆ—è¡¨ç¼“å­˜ (TTL: 5åˆ†é’Ÿ)
const cacheKey = 'posts:list:limit=20:offset=0:status=PUBLISHED'
// 1åˆ†é’Ÿåè®¿é—® â†’ ç¼“å­˜å‘½ä¸­ âœ…
```

#### 1. **å¸–å­åˆ—è¡¨æŸ¥è¯¢**
- **ç¼“å­˜å‘½ä¸­**: ğŸ¯ Cache hit for posts list
- **è¿æ¥å ç”¨**: 0ä¸ªè¿æ¥
- **å“åº”æ—¶é—´**: 1-5ms

#### 2. **è¯„è®ºæ•°é‡æŸ¥è¯¢**
- **ç¼“å­˜çŠ¶æ€**: è¯„è®ºæ•°é‡æœªç¼“å­˜ âŒ
- **è¿æ¥å ç”¨**: 20ä¸ªå¹¶å‘è¿æ¥
- **æŒç»­æ—¶é—´**: 1-2ç§’

#### 3. **ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢**
- **ç¼“å­˜çŠ¶æ€**: å¯èƒ½éƒ¨åˆ†ç¼“å­˜å‘½ä¸­
- **è¿æ¥å ç”¨**: 0-1ä¸ªè¿æ¥

### **ç”¨æˆ·Bæ€»è¿æ¥ä½¿ç”¨ç»Ÿè®¡**
| æŸ¥è¯¢ç±»å‹ | è¿æ¥æ•° | æŒç»­æ—¶é—´ | ç¼“å­˜å‘½ä¸­ |
|----------|--------|----------|----------|
| å¸–å­åˆ—è¡¨ | 0 | 1ms | âœ… |
| è¯„è®ºæ•°é‡ | 20 | 1-2ç§’ | âŒ |
| ç”¨æˆ·ä¿¡æ¯ | 0-1 | 0.1ç§’ | éƒ¨åˆ† |
| **æ€»è®¡** | **20-21** | **1-2ç§’** | **éƒ¨åˆ†** |

---

## âš ï¸ **è¿æ¥æ± çŠ¶æ€åˆ†æ**

### **è¿æ¥ç´¯åŠ æ•ˆåº”**
```
æ—¶é—´è½´åˆ†æ:
T0: ç”¨æˆ·Aè®¿é—® â†’ 23ä¸ªè¿æ¥å ç”¨
T60s: ç”¨æˆ·Bè®¿é—® â†’ 20ä¸ªæ–°è¿æ¥å ç”¨

è¿æ¥æ± çŠ¶æ€:
- é…ç½®é™åˆ¶: 25ä¸ªè¿æ¥
- ç”¨æˆ·Aè¿æ¥: å¤§éƒ¨åˆ†å·²é‡Šæ”¾ï¼ˆ6ç§’åï¼‰
- ç”¨æˆ·Bè¿æ¥: 20ä¸ªæ–°è¿æ¥
- ç´¯åŠ æ•ˆåº”: ä¸ä¼šç´¯åŠ ï¼ˆè¿æ¥å·²é‡Šæ”¾ï¼‰
```

### **è¿æ¥é‡Šæ”¾æœºåˆ¶**
```typescript
// Prismaè¿æ¥è‡ªåŠ¨é‡Šæ”¾
await prisma.post.findMany() // æŸ¥è¯¢å®Œæˆåè‡ªåŠ¨é‡Šæ”¾è¿æ¥
await prisma.comment.count() // æŸ¥è¯¢å®Œæˆåè‡ªåŠ¨é‡Šæ”¾è¿æ¥

// è¿æ¥æ± å¤ç”¨
// åŒä¸€ä¸ªPrismaå®ä¾‹çš„è¿æ¥ä¼šè¢«å¤ç”¨
// ä¸åŒæŸ¥è¯¢å¯èƒ½ä½¿ç”¨ç›¸åŒçš„ç‰©ç†è¿æ¥
```

### **å³°å€¼è¿æ¥ä½¿ç”¨åˆ†æ**
| åœºæ™¯ | å³°å€¼è¿æ¥æ•° | æŒç»­æ—¶é—´ | é£é™©ç­‰çº§ |
|------|------------|----------|----------|
| å•ç”¨æˆ·è®¿é—® | 23/25 (92%) | 6ç§’ | ğŸŸ¡ é«˜ |
| åŒç”¨æˆ·é”™å³° | 20/25 (80%) | 1-2ç§’ | ğŸŸ¡ ä¸­é«˜ |
| ä¸‰ç”¨æˆ·å¹¶å‘ | 25+/25 (100%+) | 6ç§’ | ğŸ”´ è¶…é™ |

---

## ğŸ¯ **è¯„è®ºæ‡’åŠ è½½ä¼˜åŒ–æ–¹æ¡ˆ**

### **ä¼˜åŒ–ç›®æ ‡**
- å‡å°‘åˆå§‹é¡µé¢åŠ è½½çš„è¿æ¥æ•°
- å°†è¯„è®ºæŸ¥è¯¢ä»23ä¸ªå‡å°‘åˆ°3ä¸ª
- æå‡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿç¨³å®šæ€§

### **å®æ–½ç­–ç•¥**
1. **ç§»é™¤åˆå§‹è¯„è®ºæ•°é‡æŸ¥è¯¢**
2. **æ˜¾ç¤ºé™æ€è¯„è®ºè®¡æ•°**ï¼ˆæ¥è‡ªå¸–å­ç»Ÿè®¡ï¼‰
3. **ç‚¹å‡»å±•å¼€æ—¶æ‰åŠ è½½è¯„è®º**
4. **å®æ–½è¯„è®ºæ•°æ®ç¼“å­˜**

---

## ğŸ“ˆ **ä¼˜åŒ–æ•ˆæœé¢„æœŸ**

### **è¿æ¥ä½¿ç”¨å¯¹æ¯”**
| ä¼˜åŒ–é¡¹ç›® | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„å¹…åº¦ |
|----------|--------|--------|----------|
| åˆå§‹è¿æ¥æ•° | 23ä¸ª | 3ä¸ª | -87% |
| å³°å€¼ä½¿ç”¨ç‡ | 92% | 12% | -80% |
| é¡µé¢åŠ è½½æ—¶é—´ | 6ç§’ | 2ç§’ | -67% |
| å¹¶å‘æ”¯æŒ | 1ç”¨æˆ· | 8ç”¨æˆ· | +700% |

### **ç”¨æˆ·ä½“éªŒæå‡**
- âš¡ é¡µé¢åŠ è½½é€Ÿåº¦æå‡67%
- ğŸ›¡ï¸ è¿æ¥æ± ç¨³å®šæ€§æå‡80%
- ğŸ‘¥ å¹¶å‘ç”¨æˆ·æ”¯æŒæå‡700%
- ğŸ’° æ•°æ®åº“è´Ÿè½½å‡å°‘87%

---

## ğŸ”§ **æŠ€æœ¯å®æ–½ç»†èŠ‚**

### **å‰ç«¯ä¼˜åŒ–**
```typescript
// ç§»é™¤åˆå§‹è¯„è®ºæ•°é‡æŸ¥è¯¢
// ä½¿ç”¨å¸–å­è‡ªå¸¦çš„è¯„è®ºç»Ÿè®¡
const commentCount = post._count?.comments || 0

// æ‡’åŠ è½½è¯„è®ºå†…å®¹
const [showComments, setShowComments] = useState(false)
const [comments, setComments] = useState([])

const loadComments = async () => {
  if (!showComments) {
    const data = await getCommentsByPostId(postId)
    setComments(data)
    setShowComments(true)
  }
}
```

### **åç«¯ä¼˜åŒ–**
```typescript
// å¸–å­æŸ¥è¯¢å·²åŒ…å«è¯„è®ºç»Ÿè®¡
include: {
  _count: {
    select: {
      comments: true,  // ä½¿ç”¨è¿™ä¸ªç»Ÿè®¡
      likes: true,
      starVotes: true
    }
  }
}

// è¯„è®ºAPIæ·»åŠ ç¼“å­˜
const cacheKey = `comments:${postId}`
const cached = await cacheManager.get(cacheKey)
if (cached) return cached
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ†ææ—¥æœŸ**: 2025-01-23  
**åˆ†æå¸ˆ**: å¼€å‘å›¢é˜Ÿ
